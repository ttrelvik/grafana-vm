---
- name: Create a directory for the observability stack
  ansible.builtin.file:
    path: /opt/stack
    state: directory
    mode: '0755'

- name: Copy files to the remote host
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/opt/stack/{{ item }}"
  with_items:
    - docker-compose.yml
    - prometheus.yml
    - traefik.yml
    - promtail-config/
    - grafana-config/

- name: Create acme.json for Let's Encrypt certificates
  ansible.builtin.file:
    path: /opt/stack/acme.json
    state: touch
    mode: '0600'

- name: Tear down any existing containers
  ansible.builtin.command:
    cmd: docker compose down --volumes
    chdir: /opt/stack
  environment:
    DOMAIN_NAME: "{{ domain_name }}"

- name: Launch the observability stack with Docker Compose
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: /opt/stack
  environment:
    DOMAIN_NAME: "{{ domain_name }}"
    GRAFANA_OAUTH_CLIENT_SECRET: "{{ grafana_oauth_client_secret }}"
    GRAFANA_OAUTH_CLIENT_ID: "{{ grafana_oauth_client_id }}"
    GRAFANA_OAUTH_TENANT_ID: "{{ grafana_oauth_tenant_id }}"
    GRAFANA_OAUTH_ADMIN_GROUP_ID: "{{ grafana_oauth_admin_group_id }}"
    GRAFANA_SMTP_ENABLED: "{{ grafana_smtp_enabled }}"
    GRAFANA_SMTP_HOST: "{{ grafana_smtp_host }}"
    GRAFANA_SMTP_USER: "{{ grafana_smtp_user }}"
    GRAFANA_SMTP_PASSWORD: "{{ grafana_smtp_password }}"
    GRAFANA_SMTP_FROM_ADDRESS: "{{ grafana_smtp_from_address }}"
